name: CD

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # core
      - name: Build & Push (ticketing-core)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ticketing-core/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_CORE }}:latest

      # queue
      - name: Build & Push (queue-service)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: queue-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_QUEUE }}:latest

      # staff
      - name: Build & Push (staff-api)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: staff-api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_STAFF }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 1) runnerÏóêÏÑú .env ÏÉùÏÑ±(Î©ÄÌã∞ÎùºÏù∏ ÏïàÏ†Ñ)
      - name: Make .env from ENV_FILE secret
        run: |
          mkdir -p out
          printf "%s" "${{ secrets.ENV_FILE }}" > out/.env

      # 1-2) runnerÏóêÏÑú nginxÍ∞Ä Ïì∏ static Î™®ÏúºÍ∏∞
      - name: Collect static files
        run: |
          mkdir -p out/static
          cp -r ticketing-core/src/main/resources/static/* out/static/ || true
          cp -r staff-api/src/main/resources/static/* out/static/ || true

      # 2) ÏÑúÎ≤ÑÎ°ú ÌïÑÏöîÌïú ÌååÏùº Î≥µÏÇ¨
      - name: Copy files to server (scp)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -e
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USERNAME@$SSH_HOST" "mkdir -p ~/app"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" out/.env "$SSH_USERNAME@$SSH_HOST:~/app/.env"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" docker-compose.prod.yml "$SSH_USERNAME@$SSH_HOST:~/app/docker-compose.prod.yml"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" -r static "$SSH_USERNAME@$SSH_HOST:~/app/static"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" docker/nginx/conf.d/default.conf "$SSH_USERNAME@$SSH_HOST:~/app/default.conf"

      # 3) ÏÑúÎ≤ÑÏóêÏÑú Î∞∞Ìè¨ Ïã§Ìñâ
      - name: Deploy on server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -e
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USERNAME@$SSH_HOST" <<'EOF'
            set -e
            cd ~/app

            echo "üß© move nginx conf (if needed)"
            mkdir -p docker/nginx/conf.d
            mv -f default.conf docker/nginx/conf.d/default.conf

            echo "üê≥ pull & up"
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            echo "üßº prune"
            docker image prune -f

            echo "‚úÖ done"
          EOF