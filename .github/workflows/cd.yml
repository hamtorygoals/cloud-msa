name: CD

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # core
      - name: Build & Push (ticketing-core)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ticketing-core/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_CORE }}:latest

      # queue
      - name: Build & Push (queue-service)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: queue-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_QUEUE }}:latest

      # staff
      - name: Build & Push (staff-api)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: staff-api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_STAFF }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 1) runnerì—ì„œ .env ìƒì„±(ë©€í‹°ë¼ì¸ ì•ˆì „)
      - name: Make .env from ENV_FILE secret
        run: |
          mkdir -p out
          printf "%s" "${{ secrets.ENV_FILE }}" > out/.env

      # 2) runnerì—ì„œ nginxê°€ ì“¸ static ëª¨ìœ¼ê¸°
      - name: Collect static files
        run: |
          mkdir -p out/static
          cp -r ticketing-core/src/main/resources/static/* out/static/ 2>/dev/null || true
          cp -r staff-api/src/main/resources/static/* out/static/ 2>/dev/null || true
          echo "[debug] out/static:"
          ls -al out/static || true

      # 3) nginx confë¥¼ ë ˆí¬ì—ì„œ ì°¾ì•„ out/default.confë¡œ ì¤€ë¹„
      - name: Collect nginx conf
        run: |
          set -e
          mkdir -p out

          CONF_PATH="$(ls docker/nginx/conf.d/*.conf 2>/dev/null | head -n 1 || true)"
          if [ -z "$CONF_PATH" ]; then
            CONF_PATH="$(ls nginx/conf.d/*.conf 2>/dev/null | head -n 1 || true)"
          fi

          if [ -z "$CONF_PATH" ]; then
            echo "âŒ nginx conf íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (docker/nginx/conf.d/*.conf ë˜ëŠ” nginx/conf.d/*.conf)"
            exit 1
          fi

          echo "[debug] using nginx conf: $CONF_PATH"
          cp "$CONF_PATH" out/default.conf
          ls -al out/default.conf

      # 4) ì„œë²„ë¡œ í•„ìš”í•œ íŒŒì¼ ë³µì‚¬
      - name: Copy files to server (scp)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -e

          # ì„œë²„ ë””ë ‰í† ë¦¬ ì¤€ë¹„ (ì´ê±° ë•Œë¬¸ì— ì„œë²„ì—ì„œ ë”°ë¡œ ë§Œë“¤ í•„ìš” ì—†ìŒ)
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" \
            "$SSH_USERNAME@$SSH_HOST" \
            "mkdir -p ~/app/docker/nginx/conf.d ~/app/static"

          # íŒŒì¼ ì „ì†¡ (âœ… out/staticì„ ë³´ëƒ„)
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" \
            out/.env \
            "$SSH_USERNAME@$SSH_HOST:~/app/.env"

          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" \
            docker-compose.prod.yml \
            "$SSH_USERNAME@$SSH_HOST:~/app/docker-compose.prod.yml"

          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" -r \
            out/static/* \
            "$SSH_USERNAME@$SSH_HOST:~/app/static/"

          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" \
            out/default.conf \
            "$SSH_USERNAME@$SSH_HOST:~/app/docker/nginx/conf.d/default.conf"

      # 5) ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰
      - name: Deploy on server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -e
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" \
            "$SSH_USERNAME@$SSH_HOST" <<'EOF'
              set -e
              cd ~/app

              echo "ğŸ³ pull & up"
              docker compose -f docker-compose.prod.yml down
              docker compose -f docker-compose.prod.yml pull
              docker compose -f docker-compose.prod.yml up -d

              echo "ğŸ§¼ prune"
              docker image prune -f

              echo "âœ… done"
          EOF