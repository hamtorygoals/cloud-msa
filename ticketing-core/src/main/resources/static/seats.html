<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticketing - Seats</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>

<!-- ì˜ˆì•½ ì„±ê³µ ëª¨ë‹¬ -->
<div id="codeModal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <h2>ì˜ˆì•½ ì„±ê³µ ğŸ‰</h2>
    <p class="muted">ë³´ì•ˆìš”ì›ì—ê²Œ ì•„ë˜ ì¸ì¦ë²ˆí˜¸(4ìë¦¬)ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”. <br>* í•´ë‹¹ ë²ˆí˜¸ëŠ” ë‹¤ì‹œ ë³¼ ìˆ˜ ì—†ìœ¼ë‹ˆ, ê¼­ ìº¡ì²˜í•´ì„œ ì €ì¥í•´ì£¼ì„¸ìš”!</p>
    <div id="codeBig" class="codeBig">0000</div>
    <div class="modal-actions">
      <button id="doneBtn" class="primary">í™•ì¸ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="topbar">
    <h1>ì¢Œì„ ì„ íƒ</h1>
    <div class="muted">Event: <span id="eventLabel"></span></div>
  </div>

  <div class="legend">
    <span class="chip available">AVAILABLE</span>
    <span class="chip held">HELD</span>
    <span class="chip reserved">RESERVED</span>
    <span class="chip selected">SELECTED</span>
  </div>

  <div id="grid" class="grid"></div>

  <div class="panel">
    <div>
      ì„ íƒ ì¢Œì„: <b id="selectedSeat">(ì—†ìŒ)</b>
      <div class="muted" id="holdInfo"></div>
    </div>
    <div class="actions">
      <button id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
      <button id="confirmBtn" class="primary" disabled>ì˜ˆì•½ í™•ì •</button>
    </div>
  </div>

  <p class="muted">
    <a href="/index.html">â† ì…ì¥ í™”ë©´ìœ¼ë¡œ</a>
  </p>
</div>

<script src="/app.js"></script>
<script>
  const state = {
    eventId: localStorage.getItem("eventId") || "E1",
    selectedSeatId: null,
    holdToken: null,
    holdExpiresAt: null
  };

  document.getElementById("eventLabel").textContent = state.eventId;

  const gridEl = document.getElementById("grid");
  const selectedSeatEl = document.getElementById("selectedSeat");
  const holdInfoEl = document.getElementById("holdInfo");
  const confirmBtn = document.getElementById("confirmBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  // ëª¨ë‹¬
  const modalEl = document.getElementById("codeModal");
  const codeBigEl = document.getElementById("codeBig");
  const doneBtn = document.getElementById("doneBtn");

  function openModal(code4) {
    codeBigEl.textContent = code4;
    modalEl.classList.remove("hidden");
  }
  function closeModal() {
    modalEl.classList.add("hidden");
  }

  // ì¢Œì„ ë²„íŠ¼ì„ seatIdë¡œ ë¹ ë¥´ê²Œ ì°¾ê¸°
  function seatBtn(seatId) {
    return gridEl.querySelector(`button[data-seat-id="${seatId}"]`);
  }

  // ì„ íƒì€ í•­ìƒ "1ê°œë§Œ" ìœ ì§€
  function setSelected(seatId) {
    // ì´ì „ ì„ íƒ í•´ì œ(ë”± 1ê°œë§Œ)
    if (state.selectedSeatId && state.selectedSeatId !== seatId) {
      const prev = seatBtn(state.selectedSeatId);
      if (prev) prev.classList.remove("selected");
    }

    state.selectedSeatId = seatId;

    if (seatId) {
      const cur = seatBtn(seatId);
      if (cur) cur.classList.add("selected");
      selectedSeatEl.textContent = seatId;
    } else {
      selectedSeatEl.textContent = "(ì—†ìŒ)";
    }

    confirmBtn.disabled = !(state.selectedSeatId && state.holdToken);
  }

  function setHoldInfo(text) {
    holdInfoEl.textContent = text || "";
  }

  // ê·¸ë¦¬ë“œ ìµœì´ˆ ë Œë” (í•„ìš”í•  ë•Œë§Œ ì „ì²´ ê°±ì‹ )
  async function renderFull() {
    const scrollY = window.scrollY; // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥(í˜¹ì‹œë‚˜)
    gridEl.innerHTML = "ë¡œë”©ì¤‘...";

    const seats = await apiGet(`/api/seats?eventId=${encodeURIComponent(state.eventId)}`);

    gridEl.innerHTML = "";
    seats.forEach(s => {
      const btn = document.createElement("button");
      btn.dataset.seatId = s.seatId;
      btn.className = `seat ${s.status.toLowerCase()}`;
      btn.textContent = s.seatId;

      if (state.selectedSeatId === s.seatId) btn.classList.add("selected");
      btn.disabled = (s.status === "RESERVED");

      btn.addEventListener("click", () => onSeatClick(s.seatId, s.status));
      gridEl.appendChild(btn);
    });

    // ìŠ¤í¬ë¡¤ ë³µì›(í’€ ë Œë”ì—ì„œë„ ìœ„ë¡œ íŠ€ëŠ” ëŠë‚Œ ìµœì†Œí™”)
    window.scrollTo({ top: scrollY });
  }

  // íŠ¹ì • ì¢Œì„ ë²„íŠ¼ì˜ ìƒíƒœ í´ë˜ìŠ¤ë§Œ ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¡¤ íŠ ë°©ì§€ í•µì‹¬)
  function updateSeatStatus(seatId, newStatus) {
    const btn = seatBtn(seatId);
    if (!btn) return;

    // ìƒíƒœ í´ë˜ìŠ¤ ì œê±° í›„ ìƒˆë¡œ ì ìš©
    btn.classList.remove("available", "held", "reserved");
    btn.classList.add(newStatus.toLowerCase());

    // RESERVEDë©´ ë¹„í™œì„±í™”
    btn.disabled = (newStatus === "RESERVED");
  }

  async function onSeatClick(seatId, knownStatus) {
    // ì´ë¯¸ ì„ íƒëœ ì¢Œì„ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´: "ì„ íƒ í•´ì œ"
    if (state.selectedSeatId === seatId) {
      // í™€ë“œ í† í°ê¹Œì§€ ê°™ì´ ë‚ ë ¤ë²„ë¦¬ê¸°(í™•ì • ë¶ˆê°€)
      state.holdToken = null;
      state.holdExpiresAt = null;
      setSelected(null);
      setHoldInfo("");
      confirmBtn.disabled = true;
      return;
    }

    // ë‹¤ë¥¸ ì¢Œì„ í´ë¦­ = ì´ì „ ì„ íƒì€ ìë™ í•´ì œë¨
    setSelected(seatId);
    state.holdToken = null;
    state.holdExpiresAt = null;
    setHoldInfo("");
    confirmBtn.disabled = true;

    // ì´ë¯¸ RESERVEDë¡œ ë³´ì´ë©´ ì„œë²„ í˜¸ì¶œ ì „ì— ì°¨ë‹¨(ì•ˆì „)
    if (knownStatus === "RESERVED") return;

    // ì¶”ê°€
    const queueToken = localStorage.getItem("queueToken");
    if (!queueToken) {
      alert("ëŒ€ê¸°ì—´ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì¥í•´ì£¼ì„¸ìš”.");
      window.location.href = "/queue.html";
      return;
    }

    try {
      // bodyì— queueToken ì¶”ê°€
      const res = await apiPost("/api/seats/hold", {
        eventId: state.eventId,
        seatId,
        queueToken
      });
      // const res = await apiPost("/api/seats/hold", { eventId: state.eventId, seatId });

      state.holdToken = res.holdToken;
      state.holdExpiresAt = Date.now() + (res.expiresInSec * 1000);
      setHoldInfo(`í™€ë“œ ì„±ê³µ (ë§Œë£Œ ${res.expiresInSec}ì´ˆ)`);
      confirmBtn.disabled = false;

      // ì „ì²´ ë Œë” ëŒ€ì‹ : í˜„ì¬ ì¢Œì„ë§Œ HELDë¡œ í‘œì‹œ
      updateSeatStatus(seatId, "HELD");

    } catch (e) {
      // hold ì‹¤íŒ¨ë©´ ì„ íƒ/í† í° ì´ˆê¸°í™” (ì¤‘ë³µ í™€ë“œ ë“±)
      alert(e.message || "í™€ë“œ ì‹¤íŒ¨");
      state.holdToken = null;
      state.holdExpiresAt = null;
      confirmBtn.disabled = true;

      // ì‹¤íŒ¨í–ˆìœ¼ë©´ ì„ íƒë„ í’€ì–´ì£¼ëŠ” ê²Œ UXê°€ ê¹”ë”
      setSelected(null);
      setHoldInfo("");

      // í•„ìš”í•˜ë©´ í•œë²ˆë§Œ ì „ì²´ ê°±ì‹ (ë‹¤ë¥¸ ì‚¬ëŒì´ ë¨¼ì € ì¡ì•˜ì„ ìˆ˜ ìˆìœ¼ë‹ˆ)
      // ìŠ¤í¬ë¡¤ íŠ ìµœì†Œí™”ë¥¼ ìœ„í•´ full renderëŠ” ë§ˆì§€ë§‰ì—
      await renderFull();
    }
  }

  confirmBtn.addEventListener("click", async () => {
    if (!state.selectedSeatId || !state.holdToken) return;

    const seatId = state.selectedSeatId;

    // ì¶”ê°€
    const queueToken = localStorage.getItem("queueToken");
    if (!queueToken) {
      alert("ëŒ€ê¸°ì—´ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì¥í•´ì£¼ì„¸ìš”.");
      window.location.href = "/queue.html";
      return;
    }

    try {
      // bodyì— queueToken ì¶”ê°€
      const res = await apiPost("/api/reservations/confirm", {
        eventId: state.eventId,
        seatId,
        holdToken: state.holdToken,
        queueToken
      });
      // const res = await apiPost("/api/reservations/confirm", {
      //   eventId: state.eventId,
      //   seatId,
      //   holdToken: state.holdToken
      // });

      openModal(res.code4);

      // í™•ì • í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
      state.holdToken = null;
      state.holdExpiresAt = null;
      confirmBtn.disabled = true;

      updateSeatStatus(seatId, "RESERVED");

    } catch (e) {
      alert(e.message || "ì˜ˆì•½ í™•ì • ì‹¤íŒ¨");
      // ì‹¤íŒ¨í–ˆìœ¼ë©´ ìƒíƒœ ë™ê¸°í™” í•œ ë²ˆ
      await renderFull();
    }
  });

  doneBtn.addEventListener("click", async () => {
    closeModal();

    // ìƒíƒœ ì´ˆê¸°í™”
    state.selectedSeatId = null;
    state.holdToken = null;
    state.holdExpiresAt = null;

    setSelected(null);
    setHoldInfo("");

    // í•„ìš”í•˜ë©´ í•œë²ˆë§Œ ì „ì²´ ê°±ì‹ (RESERVED ë°˜ì˜ ë³´ì¥)
    await renderFull();
  });

  refreshBtn.addEventListener("click", renderFull);

  // ìµœì´ˆ ë Œë”
  renderFull();
</script>
</body>
</html>